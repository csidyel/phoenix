version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: f1-standard-2
    os_image: ubuntu2004
blocks:
  - name: npm test
    task:
      jobs:
        - name: npm test
          commands:
            - checkout
            - cache restore
            - sem-version node 12.22.12
            - cd assets
            - npm install
            - npm test
            - cache store
    dependencies: []
  - name: integration-test-elixir
    dependencies: []
    task:
      env_vars:
        - name: FORCE_COLOR
          value: '1'
      jobs:
        - name: integration-test-elixir
          commands:
            - checkout
            - sem-version elixir 1.14.0
            - sem-version erlang 24.3.4
            - 'sudo /bin/sh -c ''wget https://github.com/earthly/earthly/releases/download/v0.5.16/earthly-linux-amd64 -O /usr/local/bin/earthly && chmod +x /usr/local/bin/earthly'''
            - earthly -P --build-arg ELIXIR=1.14.0 --build-arg OTP=24.3.4 +integration-test
  - name: mix_test
    dependencies: []
    task:
      env_vars:
        - name: MIX_ENV
          value: test
      prologue:
        commands:
          - checkout
          - cache restore
      jobs:
        - name: mix_test OTP 22.3 Elixir 1.11.4
          commands:
            - sem-version elixir 1.11.4
            - mix deps.get --only test
            - mix clean
            - mix local.rebar --force
            - mix test
            - cache store
        - name: mix_test OTP 23.3 Elixir 1.12.3
          commands:
            - sem-version elixir 1.12.3
            - mix deps.get --only test
            - mix clean
            - mix local.rebar --force
            - mix test
            - cache store
        - name: mix_test OTP 25.3 Elixir 1.14.5
          commands:
            - sem-version elixir 1.14.5
            - mix deps.get --only test
            - mix clean
            - mix local.rebar --force
            - mix test
            - cache store
        - name: mix_test OTP 26.2 Elixir 1.16.0
          commands:
            - sem-version elixir 1.16.0
            - mix deps.get --only test
            - mix clean
            - mix local.rebar --force
            - mix compile --warnings-as-errors
            - mix test
            - cd installer
            - mix test
            - cache store
